<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="/js/jp.js" type="text/javascript"></script>
  </head>
  <body>



    <script type="text/javascript">

      var margin = [50,50,50,50];
      var width = 800;
      var height = 8000;
      var xscale, yscale, cscale, countryReg
      var xaxis, yaxis;
      var svg;

      init();
      console.log('hi');
      d3.csv('/data/locs-geo-time.csv', parse, function(e,d) {
        d3.csv('/data/country-regions.csv', function(e,c) {
          countryReg = {};
          c.map(function(el) {
            countryReg[el.country] = el.id;
          })
          console.log(c)
          var secs = transformData(d);
          dataLoaded(secs);
        });
      });

      function parse(row) {
        row.start_time = new Date(row.start_time_form);
        row.end_time = new Date(row.end_time_form);
        return row;
      }

      function transformData(d) {
        var secs = d3.nest()
          .key(d3.f('sec_id'))
          .entries(d);

        for (var i = 0; i < secs.length; i++) {
          secs[i].values = calculateDiff(secs[i].values);
        }
        return secs
      }

      function calculateDiff(arr) {
        var startDate = arr[0].start_time;
        for (var i = 0; i < arr.length; i++) {
          arr[i].dayStart = d3.timeDay.count(d3.timeDay(startDate), arr[i].start_time);
          arr[i].dayEnd = d3.timeDay.count(d3.timeDay(startDate), arr[i].end_time);
        }
        return arr
      }

      function dataLoaded(secs) {
        xscale.domain(secs.map(function(d) { return d.key}));
        yscale.domain([1400,0])
        cscale.domain(['a','af','e','as','md'])
        console.log(secs)
        var secretaryG = svg.selectAll('.secretaries')
          .data(secs)
          .enter()
          .append('g.secretaries')
          .translate(function(d,i) { return [xscale(d.key), 0]});

        var trips = secretaryG.selectAll('.trip')
          .data(d3.f('values'))
          .enter()
          .append('rect.trip')
          .attr('width', xscale.bandwidth())
          .attr('height', function(d) { return yscale(d.dayEnd) - yscale(d.dayStart)})
          .translate(function(d,i) {return [0, yscale(d.dayStart)]})
          .style('fill', function(d,i) { return cscale(countryReg[d.country]);})
          .on('mouseover', function(d) { console.log(d)})
      }


      function init() {
        svg = d3.select('body').append('svg')
          .attr('width', width + margin[1] + margin[3])
          .attr('height', height + margin[0] + margin[2])
          .append('g').translate([margin[0], margin[1]]);

        xscale = d3.scaleBand()
          .domain([])
          .range([0,width])
          .padding(.1);

        yscale = d3.scaleLinear()
          .domain([])
          .range([height,0]);

        cscale = d3.scaleOrdinal(d3.schemeCategory10);

        xaxis = d3.axisLeft(yscale);
        yaxis = d3.axisBottom(xscale);

      };
    </script>

  </body>
</html>
